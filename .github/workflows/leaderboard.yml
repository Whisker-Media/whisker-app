# Thanks to https://github.com/Omniblocks/scratch-gui for this

name: Contributor Leaderboard

on:
  schedule:
    - cron: "*/90 * * * *"
  workflow_dispatch:
  push:

jobs:
  update-leaderboard:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate Stats with Python
        run: |
          python3 << 'PYTHON_SCRIPT'
          import subprocess
          import re
          from collections import defaultdict

          def get_stats(since_flag=""):
              """Get stats by collecting all commits first, then filtering"""
              
              # Get ALL commits with author name and SHA
              cmd = ["git", "log", "--format=%aN|%H", "--all"]
              if since_flag:
                  cmd.append(f"--since={since_flag}")
              
              result = subprocess.run(cmd, capture_output=True, text=True)
              
              # Group commits by author name
              author_commits = defaultdict(list)
              for line in result.stdout.strip().split('\n'):
                  if not line.strip() or '|' not in line:
                      continue
                  name, sha = line.split('|', 1)
                  author_commits[name].append(sha)
              
              # Calculate stats for each author
              stats = []
              for name, shas in sorted(author_commits.items(), key=lambda x: len(x[1]), reverse=True):
                  commits = len(shas)
                  print(f"Processing {name} ({commits} commits)...")
                  
                  additions = 0
                  deletions = 0
                  
                  # Get stats for each commit SHA directly
                  for sha in shas:
                      numstat_cmd = ["git", "show", "--numstat", "--format=", sha]
                      numstat = subprocess.run(numstat_cmd, capture_output=True, text=True)
                      
                      for stat_line in numstat.stdout.strip().split('\n'):
                          if not stat_line.strip():
                              continue
                          parts = stat_line.split()
                          if len(parts) >= 2:
                              # Skip binary files (marked with -)
                              if parts[0] == '-' or parts[1] == '-':
                                  continue
                              if parts[0].isdigit() and parts[1].isdigit():
                                  additions += int(parts[0])
                                  deletions += int(parts[1])
                  
                  total = additions + deletions
                  print(f"  â†’ {name}: +{additions} -{deletions} (total: {total})")
                  
                  stats.append((commits, name, additions, deletions, total))
              
              return stats

          # Generate all time periods
          print("ðŸ† Generating all-time stats...")
          all_time = get_stats()

          print("\nðŸ“… Generating last year stats...")
          last_year = get_stats("1 year ago")

          print("\nðŸ”¥ Generating last 30 days stats...")
          last_30 = get_stats("30 days ago")

          # Save to files
          def write_stats(stats, filename):
              with open(filename, 'w') as f:
                  for commits, name, add, delete, total in stats:
                      f.write(f"{commits}|{name}|{add}|{delete}|{total}\n")

          write_stats(all_time, "/tmp/all_time.txt")
          write_stats(last_year, "/tmp/last_year.txt")
          write_stats(last_30, "/tmp/last_30.txt")

          print("\nâœ¨ Stats generation complete!")
          PYTHON_SCRIPT

      - name: Format Leaderboard
        run: |
          timestamp=$(date -u +'%Y-%m-%d %H:%M:%S UTC')

          cat > leaderboard.md << HEADER
          # ðŸ† Contributor Leaderboard
          <!-- @traycerai ignore -->

          **Last Updated:** $timestamp

          ---

          ## ðŸ“Š All-Time Statistics

          | Rank | Contributor | Commits | Additions âž• | Deletions âž– | Total Changes |
          |------|-------------|---------|--------------|--------------|---------------|
          HEADER

          # All-time (top 20)
          rank=1
          while IFS='|' read commits name add del total; do
            [ -z "$name" ] && continue
            case $rank in
              1) medal="ðŸ¥‡ 1" ;;
              2) medal="ðŸ¥ˆ 2" ;;
              3) medal="ðŸ¥‰ 3" ;;
              *) medal="$rank" ;;
            esac
            echo "| $medal | $name | $commits | $add | $del | $total |" >> leaderboard.md
            rank=$((rank + 1))
            [ $rank -gt 20 ] && break
          done < /tmp/all_time.txt

          cat >> leaderboard.md << 'YEAR'

          ---

          ## ðŸ“… Last Year Statistics

          | Rank | Contributor | Commits | Additions âž• | Deletions âž– | Total Changes |
          |------|-------------|---------|--------------|--------------|---------------|
          YEAR

          # Last year (top 15)
          rank=1
          while IFS='|' read commits name add del total; do
            [ -z "$name" ] && continue
            case $rank in
              1) medal="ðŸ¥‡ 1" ;;
              2) medal="ðŸ¥ˆ 2" ;;
              3) medal="ðŸ¥‰ 3" ;;
              *) medal="$rank" ;;
            esac
            echo "| $medal | $name | $commits | $add | $del | $total |" >> leaderboard.md
            rank=$((rank + 1))
            [ $rank -gt 15 ] && break
          done < /tmp/last_year.txt

          cat >> leaderboard.md << 'MONTH'

          ---

          ## ðŸ”¥ Last 30 Days Statistics

          | Rank | Contributor | Commits | Additions âž• | Deletions âž– | Total Changes |
          |------|-------------|---------|--------------|--------------|---------------|
          MONTH

          # Last 30 days (top 10)
          rank=1
          while IFS='|' read commits name add del total; do
            [ -z "$name" ] && continue
            case $rank in
              1) medal="ðŸ¥‡ 1" ;;
              2) medal="ðŸ¥ˆ 2" ;;
              3) medal="ðŸ¥‰ 3" ;;
              *) medal="$rank" ;;
            esac
            echo "| $medal | $name | $commits | $add | $del | $total |" >> leaderboard.md
            rank=$((rank + 1))
            [ $rank -gt 10 ] && break
          done < /tmp/last_30.txt

          # Repository summary
          total_commits=$(git rev-list --count HEAD)
          total_contributors=$(git shortlog -sn --all | wc -l)
          total_stats=$(git log --pretty=tformat: --numstat | awk 'BEGIN {add=0;del=0} $1!="-"&&$2!="-"&&$1~/^[0-9]+$/&&$2~/^[0-9]+$/ {add+=$1;del+=$2} END {print add,del}')
          total_add=$(echo "$total_stats" | cut -d' ' -f1)
          total_del=$(echo "$total_stats" | cut -d' ' -f2)

          cat >> leaderboard.md << FOOTER

          ---

          ## ðŸ“ˆ Repository Summary

          - **Total Commits:** $total_commits
          - **Total Contributors:** $total_contributors
          - **Total Additions:** $total_add âž•
          - **Total Deletions:** $total_del âž–
          - **Net Changes:** $((total_add - total_del))

          ---

          *This leaderboard is automatically updated daily by [GitHub Actions](https://github.com/${{ github.repository }}/actions/workflows/leaderboard.yml)*
          FOOTER

          {
            echo "BODY<<ENDOFBODY"
            cat leaderboard.md
            echo "ENDOFBODY"
          } >> $GITHUB_OUTPUT
        id: format

      - name: Update Issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue edit 17 --body "${{ steps.format.outputs.BODY }}"
          echo "âœ… Leaderboard updated successfully! ðŸŽ‰"
