name: HF AI Issue Labeller

on:
  issues:
    types: [opened, edited]

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests PyGithub

      - name: Label issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
        run: |
          python - <<'EOF'
          import os
          import requests
          from github import Github

          # Use the Hugging Face **router inference endpoint**
          API_URL = "https://router.huggingface.co/hf-inference/models/facebook/bart-large-mnli"
          HF_HEADERS = {"Authorization": f"Bearer {os.environ['HF_TOKEN']}"}

          gh = Github(os.environ["GITHUB_TOKEN"])
          repo = gh.get_repo(os.environ["REPO"])
          issue_number = int(os.environ["ISSUE_NUMBER"])
          issue = repo.get_issue(number=issue_number)

          allowed_labels = ["Low Priority", "Medium Priority", "High Priority", "bug", "feature", "enhancement", "documentation", "question"]

          def classify(text, labels):
              payload = {
                  "inputs": text,
                  "parameters": {"candidate_labels": labels}
              }
              try:
                  r = requests.post(API_URL, headers=HF_HEADERS, json=payload, timeout=30)
                  r.raise_for_status()
                  return r.json()
              except Exception as e:
                  print("HF API error:", e)
                  return None

          text = f"{issue.title}\n{issue.body or ''}"
          print("Text to classify:", text)

          result = classify(text, allowed_labels)
          if not result:
              print("Skipping labeling.")
              exit(1)

          print("HF result:", result)

          # Depending on HF output format, it might use keys "labels"/"scores" or similar
          labels_to_apply = [label for label, score in zip(result.get("labels", []), result.get("scores", [])) if score > 0.3]

          if labels_to_apply:
              issue.add_to_labels(*labels_to_apply)
              print("Applied labels:", labels_to_apply)
          else:
              print("No labels above threshold.")
          EOF
