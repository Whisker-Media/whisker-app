name: HF AI Issue Labeller

on:
  issues:
    types: [opened, edited]

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests PyGithub

      - name: Label issue or PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
        run: |
          python - <<'EOF'
          import os
          import requests
          from github import Github

          # Hugging Face zero-shot classification
          API_URL = "https://api-inference.huggingface.co/models/facebook/bart-large-mnli"
          HF_HEADERS = {"Authorization": f"Bearer {os.environ['HF_TOKEN']}"}

          # GitHub API setup
          gh = Github(os.environ["GITHUB_TOKEN"])
          repo = gh.get_repo(os.environ["REPO"])
          issue_number = int(os.environ["ISSUE_NUMBER"])
          issue = repo.get_issue(number=issue_number)

          # Allowed labels
          allowed_labels = ["Low Priority", "Medium Priority", "High Priority", "bug", "feature", "enhancement"]

          def query_hf(text, candidate_labels):
              payload = {"inputs": text, "parameters": {"candidate_labels": candidate_labels}}
              try:
                  response = requests.post(API_URL, headers=HF_HEADERS, json=payload, timeout=30)
                  response.raise_for_status()
                  return response.json()
              except Exception as e:
                  print("Error querying HF:", e)
                  return None

          # Combine title and body
          text = f"{issue.title}\n{issue.body or ''}"
          print("Issue/PR text:", text)

          # Query Hugging Face
          result = query_hf(text, allowed_labels)
          if result is None:
              print("HF query failed, skipping labeling.")
              exit(1)

          print("HF response:", result)

          # Apply labels above a confidence threshold
          threshold = 0.3
          labels_to_apply = [label for label, score in zip(result["labels"], result["scores"]) if score > threshold]

          if labels_to_apply:
              issue.add_to_labels(*labels_to_apply)
              print("Labels applied:", labels_to_apply)
          else:
              print("No labels matched confidently.")
          EOF
