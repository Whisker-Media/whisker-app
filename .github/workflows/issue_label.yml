name: Issue Labeller

on:
  issues:
    types: [opened, edited]

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests PyGithub

      - name: Label issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GOOGLE_API_KEY: ${{ secrets.HF_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
        run: |
          python - <<'EOF'
          import os
          import requests
          from github import Github, Auth

          # GitHub setup using recommended Auth.Token
          gh = Github(auth=Auth.Token(os.environ["GITHUB_TOKEN"]))
          repo = gh.get_repo(os.environ["REPO"])
          issue_number = int(os.environ["ISSUE_NUMBER"])
          issue = repo.get_issue(number=issue_number)

          # Allowed labels
          allowed_labels = ["Low Priority", "Medium Priority", "High Priority", "bug", "feature", "enhancement"]

          # Prepare prompt for Google AI
          text = f"{issue.title}\n{issue.body or ''}"
          prompt = f"Suggest relevant GitHub labels from this list: {', '.join(allowed_labels)}\n\nText:\n{text}\n\nRespond with a comma-separated list using only these labels."

          # Call Google Generative Language API (text-bison-001)
          api_key = os.environ["GOOGLE_API_KEY"]
          url = f"https://api.generativelanguage.googleapis.com/v1beta2/models/text-bison-001:generate?key={api_key}"
          payload = {
              "prompt": {"text": prompt},
              "temperature": 0.0,
              "candidate_labels": allowed_labels  # optional, helps AI focus
          }

          try:
              response = requests.post(url, json=payload, timeout=30)
              response.raise_for_status()
              data = response.json()
              # The generated text is usually here:
              output_text = data.get("candidates", [{}])[0].get("output", "")
              print("AI output:", output_text)
          except Exception as e:
              print("Google AI API error:", e)
              exit(1)

          # Extract labels that match allowed labels
          labels_to_apply = [label for label in allowed_labels if label.lower() in output_text.lower()]

          if labels_to_apply:
              issue.add_to_labels(*labels_to_apply)
              print("Applied labels:", labels_to_apply)
          else:
              print("No valid labels found from AI output.")
          EOF
