name: Issue Labeller

on:
  issues:
    types: [opened, edited]

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install google-genai PyGithub

      - name: Label issue or PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GOOGLE_API_KEY: ${{ secrets.HF_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
        run: |
          python - <<'EOF'
          import os
          from github import Github, Auth
          import google.genai as genai

          # GitHub setup
          gh = Github(auth=Auth.Token(os.environ["GITHUB_TOKEN"]))
          repo = gh.get_repo(os.environ["REPO"])
          issue_number = int(os.environ["ISSUE_NUMBER"])
          issue = repo.get_issue(number=issue_number)

          allowed_labels = ["Low Priority", "Medium Priority", "High Priority", "bug", "feature", "enhancement"]

          # Prepare prompt
          text = f"{issue.title}\n{issue.body or ''}"
          prompt = f"Suggest relevant GitHub labels from this list: {', '.join(allowed_labels)}\n\nText:\n{text}\n\nRespond with a comma-separated list using only these labels."

          # Initialize Gemini client
          client = genai.Client(api_key=os.environ["GOOGLE_API_KEY"])

          # Generate response
          try:
              response = client.models.generate_content(
                  model="gemini-2.5-flash",
                  contents=prompt
              )
              output_text = response.text
              print("AI output:", output_text)
          except Exception as e:
              print("Google Gemini API error:", e)
              exit(1)

          # Match labels
          labels_to_apply = [label for label in allowed_labels if label.lower() in output_text.lower()]

          if labels_to_apply:
              issue.add_to_labels(*labels_to_apply)
              print("Applied labels:", labels_to_apply)
          else:
              print("No valid labels found from AI output.")
          EOF
