name: AI Issue Labeller

on:
  issues:
    types: [opened, edited]

jobs:
  label:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: AI Label Issue
        run: |
          node -e "
          import fetch from 'node-fetch';
          import puter from 'https://esm.sh/puter.js@2.0.0';

          const issueNumber = process.env.ISSUE_NUMBER;
          const issueBody = process.env.ISSUE_BODY;
          const repo = process.env.GITHUB_REPOSITORY;
          const token = process.env.GITHUB_TOKEN;

          // Allowed labels
          const allowedLabels = [
            'bug',
            'documentation',
            'duplicate',
            'enhancement',
            'High Priority',
            'Medium Priority',
            'Low Priority',
            'question'
          ];

          (async () => {
            // Ask AI to suggest labels from predefined list
            const labelsResponse = await puter.ai.chat(
              `Suggest the most appropriate GitHub labels for this issue from this list: ${allowedLabels.join(', ')}. Only pick relevant ones: ${issueBody}`,
              { model: 'gpt-5-nano' }
            );

            // Convert AI response to array and filter allowed labels
            const suggestedLabels = labelsResponse
              .split(/,|\\n/)
              .map(l => l.trim())
              .filter(l => allowedLabels.includes(l));

            if(suggestedLabels.length === 0){
              console.log('No valid labels suggested by AI.');
              return;
            }

            // Apply labels via GitHub API
            await fetch(`https://api.github.com/repos/${repo}/issues/${issueNumber}/labels`, {
              method: 'POST',
              headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ labels: suggestedLabels })
            });

            console.log('Labels applied:', suggestedLabels);
          })();
        "
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          GITHUB_REPOSITORY: ${{ github.repository }}
